version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: lectgen-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - lectgen-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lectgen -d lectgen_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: lectgen-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    networks:
      - lectgen-network
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # Redis (for BullMQ/Queue)
  redis:
    image: redis:7-alpine
    container_name: lectgen-redis
    command: sh -c "if [ -n \"$REDIS_PASSWORD\" ]; then redis-server --requirepass $REDIS_PASSWORD; else redis-server; fi"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - lectgen-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin4 (Database Management UI)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: lectgen-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_DEFAULT_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_DEFAULT_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    ports:
      - "${PGADMIN_PORT:-5050}:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - lectgen-network
    depends_on:
      postgres:
        condition: service_healthy

  whisper:
    image: ghcr.io/ggml-org/whisper.cpp:main
    container_name: lectgen-whisper
    restart: always
    entrypoint:
      [
        "bash",
        "-lc",
        "tr -d '\\r' < /start-whisper.sh > /tmp/start-whisper.sh; chmod +x /tmp/start-whisper.sh; exec bash /tmp/start-whisper.sh",
      ]
    environment:
      WHISPER_MODEL_NAME: medium
      WHISPER_LANGUAGE: vi
      WHISPER_SUPPRESS_NST: "0"
      WHISPER_PROMPT: "Đây là bài thuyết trình về học tập, nghiên cứu, công nghệ, kinh doanh"
      WHISPER_THREADS: "8"
      WHISPER_BEST_OF: "5"
      WHISPER_BEAM_SIZE: "5"
      WHISPER_TEMPERATURE: "0.0"
    volumes:
      - whisper_models:/models
      - ./scripts/start-whisper.sh:/start-whisper.sh:ro
    ports:
      - "8081:8080"
    networks:
      - lectgen-network

  # Backend (Development with hot reload)
  backend:
    build:
      context: ./backend
      dockerfile: ../Dockerfile.backend.dev
    container_name: lectgen-backend
    restart: always
    env_file:
      - ./.env
    environment:
      NODE_ENV: development
      PORT: ${PORT:-5000}
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:${POSTGRES_PORT:-5432}/${POSTGRES_DB}
      MINIO_ENDPOINT: minio
      MINIO_PORT: ${MINIO_PORT:-9000}
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      MINIO_USE_SSL: ${MINIO_USE_SSL:-false}
      REDIS_URL: redis://:${REDIS_PASSWORD:-}@redis:${REDIS_PORT:-6379}
      STT_PROVIDER: ${STT_PROVIDER:-local}
      WHISPER_BASE_URL: ${WHISPER_BASE_URL:-http://whisper:8080}
    ports:
      - "5000:5000"
      - "9229:9229"
    volumes:
      - ./backend:/app
      - /app/node_modules
    networks:
      - lectgen-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy
      whisper:
        condition: service_started
    develop:
      watch:
        - path: ./backend/src
          action: sync+restart
          target: /app/src
        - path: ./backend/package.json
          action: rebuild
  # Frontend 
  frontend:
    build:
      context: ./frontend
      dockerfile: ../Dockerfile.frontend.dev
    container_name: lectgen-frontend
    restart: always
    env_file:
      - ./.env
    environment:
      NODE_ENV: development
      VITE_API_URL: ${VITE_API_URL:-http://localhost:5000/api}
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    networks:
      - lectgen-network
    depends_on:
      - backend
    develop:
      watch:
        - path: ./frontend/src
          action: sync
          target: /app/src
        - path: ./frontend/package.json
          action: rebuild

volumes:
  postgres_data:
  minio_data:
  redis_data:
  pgadmin_data:
  whisper_models:

networks:
  lectgen-network:
    driver: bridge
